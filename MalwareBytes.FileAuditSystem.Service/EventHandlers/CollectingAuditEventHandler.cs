using MalwareBytes.FileAuditSystem.Domain.Entity;
using MalwareBytes.FileAuditSystem.Service.Abstract;
using System.Diagnostics.Eventing.Reader;
using System.IO;
using System.Threading.Tasks;

namespace MalwareBytes.FileAuditSystem.Service.EventHandlers
{
    public class CollectingAuditEventHandler : AuditEventHandler
    {
        public async override Task HandleRequest(EventRecordWrittenEventArgs source, EventEntity target)
        {
            var eventRecord = source.EventRecord;
            target.EventTime = eventRecord.TimeCreated.Value.ToUniversalTime().ToString("o");
            target.FileName = Path.GetFileName(eventRecord.Properties[6].Value.ToString());
            target.ProcessID = eventRecord.ProcessId.Value.ToString();
            target.Domain = eventRecord.Properties[2].Value.ToString();
            target.User = eventRecord.Properties[1].Value.ToString();

            if (_nextHandler != null)
            {
                await _nextHandler.HandleRequest(source, target);
            }
        }
    }
}
